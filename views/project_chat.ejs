<% include layout_header %>
<% include layout_project_sidebar %>

<script>
	var room = '<%=room%>';
	var scr_num = 0; //스크롤할 곳 추적용
	var temp_ballon = -1; //파일첨부 로딩창 추적용
	var thumbnail; //썸네일 이미지 저장소
	var myname = '<%=user.name%>';
	var myid = '<%=user.pid%>';
	function GetFileName() {
		var fileInput = document.getElementsByClassName('uniqueUpload')[0];
		var fileName = fileInput.value.split(/(\\|\/)/g).pop();
		return fileName;
      }
	function sendMessage(mtype, data) {
		$.ajax({
			type:'post',
			url:'./chat',
			data : {
				mode : 'send',
				type : mtype,
				myname:myname,
				myid:myid,
				content : data.text,
				original: data.original,
				size: data.size
			}, success : function(data2) {
				socket.emit('client_emit', {signiture : data2.signiture, room : room});
			}
		});
	}
	
	function receiveMessage(sig) {
		$.ajax({
			type:'post',
			url:'./chat',
			data : {
				mode : 'receive',
				myname:myname,
				myid:myid,
				signiture : sig
			}, success : function(data) {
				++scr_num;
				var isme = false;
				var className = "ballon scr_offset" + scr_num;
				if(data.writer_name == myname) {
					className = "ballon me scr_offset" + scr_num;
					isme = true;
				}
				var noticlassName = "scr_offset" + scr_num;
				if(data.type == "File") {
					if(isme)
						$('#chattingWindow .room').append("<div class='" + className+"'>" + "<a href='/files/" + data.content + "'><span class=\"glyphicon glyphicon-file\" aria-hidden=\"true\"></span> " + data.original + "</a><br>"+data.date+"</div>");
					else
						$('#chattingWindow .room').append("<div class='" + className+"'><b>" + data.writer_name + "</b> <a href='/files/" + data.content + "'><span class=\"glyphicon glyphicon-file\" aria-hidden=\"true\"></span> " + data.original + "</a><br>"+data.date+"</div>");
				} else if(data.type == "notification") {
					$('#chattingWindow .room').append("<div class='" + noticlassName + " .notification'>" + data.content + "</div>");
				} else {
					if(isme)
						$('#chattingWindow .room').append("<div class='" + className + "'>" + data.content + "<br>"+data.date+"</div>");
					else
						$('#chattingWindow .room').append("<div class='" + className + "'><b>" + data.writer_name + "</b> " + data.content + "<br>"+data.date+"</div>");
				}
				//적절한 위치로 스크롤
				$('.scr_offset'+scr_num).ScrollTo({
					duration: 500,
					easing: 'linear'
				});
			}
		});
	}
	
</script>
<div class="col-md-10">
	<!--<h3>닉네임 : <script>document.write(name);</script></h3>-->
	<div id="chattingWindow">
		<div class="room">
			<!--대화 내용-->
		</div>
		<div class="afterMessage"> ↓ 추가 메시지 : 0개 </div>
		<div class="control">
			<form name="multiform" id="multiform" action="/files" enctype="multipart/form-data" method="POST">
				<div class="form-group image-upload">
					<label for="file">
						<img src="/imgs/placeholder.jpg" width="40px"/>
					</label>
					<input type="file" id="file" name="uploadFile" class="uniqueUpload"/>
				</div>
			</form>
			<!--말할수 있는 부분-->
			<form action="#" id="cf">
				<input type="text" class="inputText" id="type"/>
			</form>
		</div>
	</div>
	<script type="text/javascript">
	$('body').ready(function () {$('#type').focus();});
	$('body').keydown(function () {$('#type').focus();});
		var socket = io.connect('ws://<%= ws_addr %>:8080');
		//기존 채팅 내용 불러오기
		$.ajax({
			type:'get',
			url:'./cc.do',
			success : function (data) {
				for(var i = 0; i < data.length; i++) {
					++scr_num;
					var isme = false;
					var className = "ballon scr_offset" + scr_num;
					if(data[i].pid == myid) {
						className = "ballon me scr_offset" + scr_num;
						isme = true;
					}
					var noticlassName = "scr_offset" + scr_num;
					if(data[i].type == "File") {
					if(isme)
						$('#chattingWindow .room').append("<div class='" + className +"'>" + "<a href='/files/" + data[i].content + "'><span class=\"glyphicon glyphicon-file\" aria-hidden=\"true\"></span> " + data[i].original + "</a><br>"+data[i].created_date+"</div>");
					else
						$('#chattingWindow .room').append("<div class='" + className +"'><b>" + data[i].name + "</b> <a href='/files/" + data[i].content + "'><span class=\"glyphicon glyphicon-file\" aria-hidden=\"true\"></span> " + data[i].original + "</a><br>"+data[i].created_date+"</div>");
					} else if(data[i].type == "notification") {
						//$('#chattingWindow .room').append("<div class='" + noticlassName + " .notification'>" + data[i].content + "</div>");
					} else {
						if(isme)
							$('#chattingWindow .room').append("<div class='" + className + "'>" + data[i].content + "<br>"+data[i].created_date+"</div>");
						else
							$('#chattingWindow .room').append("<div class='" + className + "'><b>" + data[i].name + "</b> " + data[i].content + "<br>"+data[i].created_date+"</div>");
					}
				}
				$('.scr_offset'+scr_num).ScrollTo({
					duration: 500,
					easing: 'linear'
				});
				socket.emit('join_the_room', {room:'<%=room%>'});
				sendMessage('notification', {text:'<%=user.name%>님이 입장하셨습니다.'});
			}
		});
		socket.on('client_on', function(data) {
			receiveMessage(data);
		});


		$('#cf').submit(function (event) {
			event.preventDefault();
			if($('#type').val() == "")
				return;
			var str = $('#type').val();
			sendMessage('PlainText', {text:str});
			$('#type').val("");
		});

		var cnt;
		var isUpdated = true;
		//파일 전송 프로그레스 처리용
		(function() {

			//var bar = $('.bar');
			//var percent = $('.percent');
			//var status = $('#status');

			$('#multiform').ajaxForm({
				beforeSend: function() {
					if(!isUpdated ) {
						alert('죄송합니다. 기능상의 문제로 하나씩 업로드가 가능합니다. 취소하려면 X버튼을 눌러 업로드를 중지하세요.');
						$(this).abort();
					}
					isUpdated = false;
					++temp_ballon;
					var className = 'ballon me tmp' + temp_ballon;
					cnt = $("<div class='"+className+"'>파일을 전송 중입니다..<br>"+ GetFileName() +"(0%)</div>").appendTo('#chattingWindow .room');
					//status.empty();
					//var percentVal = '0%';
					//bar.width(percentVal)
					//percent.html(percentVal);
				},
				uploadProgress: function(event, position, total, percentComplete) {
					var percentVal = percentComplete + '%';
					//cnt.html('<img src="'+thumbnail+'" width="50"/> 파일을 전송 중입니다..<br>image.jpg ('+ percentVal+')');
					cnt.html('파일을 전송 중입니다..<br>'+ GetFileName() +' ('+ percentVal+')');
					//bar.width(percentVal)
					//percent.html(percentVal);
				},
				success: function() {
					//var percentVal = '100%';
					cnt.html('전송이 완료되었어요!');
					//bar.width(percentVal)
					//percent.html(percentVal);
				},
				complete: function(xhr) {
					//status.html(xhr.responseText);
					$("form").each(function() {
						if(this.id == "multiform") this.reset();
					});
					cnt.remove();
					isUpdated = true;
					var s = JSON.parse(xhr.responseText);
					sendMessage('File', {text:s.filename, original:s.originalname, size:s.size}); //Message Push
				}
			});

		})();


	if (window.FileReader) {
		function handleFileSelect(evt) {
			var files = evt.target.files;
			var f = files[0];
			var reader = new FileReader();

			reader.onload = (function(theFile) {
				return function(e) {
					//document.getElementById('list').innerHTML = ['<img src="', e.target.result,'" title="', theFile.name, '" width="50"/>'].join('');
					//thumbnail = e.target.result;
					thumbnail='#';//렉걸려 ㅡㅡ
					$("#multiform").submit();
				};
			})(f);

			reader.readAsDataURL(f);
		}
	} else {
		alert('This browser does not support FileReader');
	}
	document.getElementById('file').addEventListener('change', handleFileSelect, false);
	</script>

</div>
<% include layout_footer %>
